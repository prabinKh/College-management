{% extends 'Home/base.html' %}
{% load static %}

{% block title %}{{ semester_subject.subject.subject_name }}{% endblock %}

{% block extra_head %}
<meta name="csrf-token" content="{{ csrf_token }}">
{% endblock %}

{% block body %}
<div class="page-wrapper">
    <div class="content container-fluid">
        <div class="page-header">
            <div class="row align-items-center">
                <div class="col">
                    <h3 class="page-title">{{ semester_subject.subject.subject_name }}</h3>
                    <ul class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{% url 'admin_dashboard' %}">Dashboard</a></li>
                        <li class="breadcrumb-item"><a href="{% url 'semesters:semester_list' %}">Semesters</a></li>
                        <li class="breadcrumb-item"><a href="{% url 'semesters:semester_detail' semester.slug %}">{{ semester.semester_name }}</a></li>
                        <li class="breadcrumb-item active">{{ semester_subject.subject.subject_name }}</li>
                    </ul>
                </div>
                <div class="col-auto">
                    {% if user.is_authenticated %}
                    <a href="{% url 'semesters:semester_detail' semester.slug %}" class="btn btn-outline-secondary  fas fa-arrow-left me-2">Back</a>
                    <button class="btn btn-outline-danger delete-subject" data-subject-id="{{ semester_subject.id }}">Delete Subject</button>
                    {% else %}
                    <a href="{% url 'login' %}?next={{ request.path }}" class="btn btn-outline-secondary me-2">Back (Login)</a>
                    <a href="{% url 'login' %}?next={% url 'semesters:edit_semester_subject' semester.slug semester_subject.id %}" class="btn btn-outline-primary me-2">Edit Subject (Login)</a>
                    <button class="btn btn-outline-danger" disabled title="Login required to delete">Delete Subject (Login)</button>
                    {% endif %}
                </div>
            </div>
        </div>

        {% if messages %}
        <div class="alert-container">
            {% for message in messages %}
            <div class="alert alert-{% if message.tags == 'success' %}success{% elif message.tags == 'error' %}danger{% else %}warning{% endif %} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Toast container for notifications -->
        <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;">
            <div id="liveToast" class="toast align-items-center border-0" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body" id="toastMessage"></div>
                    <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        </div>

        {% if not user.is_authenticated %}
        <div class="alert alert-warning alert-dismissible fade show" role="alert">
            You are not logged in. Please <a href="{% url 'login' %}?next={{ request.path }}">log in</a> to perform actions like editing or deleting.
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endif %}

        <div class="row">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title">Subject Details</h4>
                    </div>
                    <div class="card-body">
                        <p><strong>Subject:</strong> {{ semester_subject.subject.subject_name }}</p>
                        <p><strong>Class:</strong> {{ semester_subject.subject.class_name|default:"N/A" }}</p>
                        <p><strong>Credits:</strong> {{ semester_subject.credits }}</p>
                        <p><strong>Hours/Week:</strong> {{ semester_subject.hours_per_week }}</p>
                        <p><strong>Teacher:</strong>
                            {% if semester_subject.teacher %}
                            {{ semester_subject.teacher.get_full_name|default:"Not Assigned" }}
                            <button class="btn btn-sm btn-outline-danger remove-teacher" data-teacher-email="{{ semester_subject.teacher.email }}">Remove</button>
                            {% else %}
                            <span class="text-muted">Not Assigned</span>
                            {% endif %}
                        </p>
                    </div>
                    <div class="card-footer">
                        <div class="mb-2">
                            <label><strong>Change Teacher:</strong></label>
                            <div class="input-group">
                                <input type="text" id="teacherSearch" class="form-control" placeholder="Search teacher by email or name" autocomplete="off">
                                <button class="btn btn-outline-primary" type="button" id="searchTeacherBtn">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                            <div id="teacherResults" class="list-group mt-2" style="display: none;"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title">Manage Students</h4>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <input type="text" id="studentSearch" class="form-control" placeholder="Search students by name, email, or ID">
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <h5>Available Students</h5>
                                <select multiple id="availableStudents" class="form-control" size="10"></select>
                                <button class="btn btn-primary mt-2" id="addStudents">Add Selected</button>
                            </div>
                            <div class="col-md-6">
                                <h5>Enrolled Students</h5>
                                <select multiple id="enrolledStudents" class="form-control" size="10"></select>
                                <button class="btn btn-danger mt-2" id="removeStudents">Remove Selected</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteSubjectModal" tabindex="-1" aria-labelledby="deleteSubjectModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteSubjectModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete the subject <strong>{{ semester_subject.subject.subject_name }}</strong>? This will remove all student enrollments for this subject, and students with no other subjects in this semester will also be removed from the semester enrollment. This action cannot be undone.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteSubject">
                    <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                    Delete
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Remove Teacher Confirmation Modal -->
<div class="modal fade" id="removeTeacherModal" tabindex="-1" aria-labelledby="removeTeacherModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="removeTeacherModalLabel">Confirm Teacher Removal</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to remove the teacher from this subject?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmRemoveTeacher">
                    <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                    Remove
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Remove Student Confirmation Modal -->
<div class="modal fade" id="removeStudentModal" tabindex="-1" aria-labelledby="removeStudentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="removeStudentModalLabel">Confirm Student Removal</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to remove the selected students from this subject? If a student has no other subjects in this semester, they will also be removed from the semester enrollment.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmRemoveStudent">
                    <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                    Remove
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    .card { margin-bottom: 1.5rem; }
    .alert-container { position: relative; z-index: 1050; }
    .toast-container { z-index: 9999; }
    .btn:disabled { opacity: 0.6; }
    .spinner-border-sm { width: 1rem; height: 1rem; }
    .teacher-result-item { cursor: pointer; padding: 8px 15px; }
    .teacher-result-item:hover { background-color: #f8f9fa; }
    select[multiple] { width: 100%; height: 200px; }
</style>

<script src="{% static 'assets/js/jquery-3.6.0.min.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="{% static 'assets/js/script.js' %}"></script>
<script>
$(document).ready(function() {
    // Wait for Bootstrap to be fully loaded
    if (typeof bootstrap === 'undefined') {
        console.error('Bootstrap is not loaded properly');
        return;
    }

    // Initialize modals and toast
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteSubjectModal'));
    const removeTeacherModal = new bootstrap.Modal(document.getElementById('removeTeacherModal'));
    const removeStudentModal = new bootstrap.Modal(document.getElementById('removeStudentModal'));
    const toastEl = document.getElementById('liveToast');
    const toast = new bootstrap.Toast(toastEl);

    // Get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    const csrftoken = getCookie('csrftoken') || $('meta[name=csrf-token]').attr('content') || '{{ csrf_token }}';

    // Function to show toast notifications
    function showToast(type, message) {
        const toastEl = document.getElementById('liveToast');
        const toastBody = document.getElementById('toastMessage');
        toastEl.className = 'toast align-items-center border-0';
        if (type === 'success') {
            toastEl.classList.add('text-bg-success');
        } else if (type === 'error') {
            toastEl.classList.add('text-bg-danger');
        } else {
            toastEl.classList.add('text-bg-warning');
        }
        toastBody.textContent = message;
        toast.show();
    }

    // Teacher search functionality
    let teacherSearchTimeout;
    const teacherSearchInput = $('#teacherSearch');
    const teacherResults = $('#teacherResults');

    teacherSearchInput.on('input', function() {
        clearTimeout(teacherSearchTimeout);
        const query = $(this).val().trim();

        if (query.length < 2) {
            teacherResults.hide();
            return;
        }

        teacherSearchTimeout = setTimeout(() => {
            $.ajax({
                url: "{% url 'semesters:search_teachers' %}",
                type: 'GET',
                data: { q: query, subject_id: {{ semester_subject.id }} },
                success: function(data) {
                    teacherResults.empty();
                    if (data.teachers && data.teachers.length > 0) {
                        data.teachers.forEach(teacher => {
                            teacherResults.append(`
                                <a href="#" class="list-group-item list-group-item-action teacher-result-item" 
                                   data-email="${teacher.email}" data-name="${teacher.name}">
                                    <strong>${teacher.name}</strong><br>
                                    <small>${teacher.email}</small>
                                </a>
                            `);
                        });
                        teacherResults.show();
                    } else {
                        teacherResults.html('<div class="list-group-item">No teachers found</div>').show();
                    }
                },
                error: function() {
                    teacherResults.html('<div class="list-group-item text-danger">Error searching teachers</div>').show();
                }
            });
        }, 300);
    });

    // Handle teacher selection
    $(document).on('click', '.teacher-result-item', function(e) {
        e.preventDefault();
        const email = $(this).data('email');
        const name = $(this).data('name');

        if (confirm(`Assign ${name} as teacher for this subject?`)) {
            assignTeacher(email);
        }
        teacherResults.hide();
    });

    // Assign teacher function
    function assignTeacher(email) {
        const button = $('#searchTeacherBtn');
        const spinner = button.find('.spinner-border');
        button.prop('disabled', true);
        spinner.removeClass('d-none');

        $.ajax({
            url: "{% url 'semesters:edit_semester_subject' semester.slug semester_subject.id %}",
            type: 'POST',
            headers: { 'X-CSRFToken': csrftoken },
            data: { teacher_email: email },
            success: function(response) {
                if (response.success) {
                    showToast('success', response.message || 'Teacher assigned successfully');
                    location.reload();
                } else {
                    showToast('error', response.error || 'Failed to assign teacher');
                }
            },
            error: function(xhr) {
                let errorMessage = 'Error assigning teacher';
                try {
                    const response = JSON.parse(xhr.responseText);
                    errorMessage = response.error || errorMessage;
                } catch (e) {
                    if (xhr.status === 404) errorMessage = 'Teacher or subject not found';
                    else if (xhr.status === 403) errorMessage = 'Permission denied';
                    else errorMessage = xhr.statusText || errorMessage;
                }
                showToast('error', errorMessage);
            },
            complete: function() {
                button.prop('disabled', false);
                spinner.addClass('d-none');
            }
        });
    }

    // Load students function
    function loadStudents(query = '') {
        $.ajax({
            url: "{% url 'semesters:get_subject_students' semester.slug semester_subject.id %}",
            type: 'GET',
            data: { q: query },
            success: function(data) {
                if (data.success) {
                    $('#availableStudents').empty();
                    $('#enrolledStudents').empty();

                    data.available_students.forEach(student => {
                        $('#availableStudents').append(
                            `<option value="${student.id}">${student.name} (${student.email})</option>`
                        );
                    });

                    data.enrolled_students.forEach(student => {
                        $('#enrolledStudents').append(
                            `<option value="${student.id}">${student.name} (${student.email})</option>`
                        );
                    });
                } else {
                    showToast('error', data.error || 'Failed to load students');
                }
            },
            error: function(xhr) {
                let errorMessage = 'Error loading students';
                try {
                    const response = JSON.parse(xhr.responseText);
                    errorMessage = response.error || errorMessage;
                } catch (e) {
                    if (xhr.status === 404) errorMessage = 'Subject or semester not found';
                    else if (xhr.status === 403) errorMessage = 'Permission denied';
                    else errorMessage = xhr.statusText || errorMessage;
                }
                showToast('error', errorMessage);
            }
        });
    }

    // Initial load
    loadStudents();

    // Student search
    $('#studentSearch').on('input', function() {
        loadStudents($(this).val());
    });

    // Add students
    $('#addStudents').on('click', function() {
        const selectedStudents = $('#availableStudents').val();
        if (!selectedStudents || selectedStudents.length === 0) {
            showToast('error', 'Please select at least one student to add');
            return;
        }

        const formData = new FormData();
        formData.append('action', 'add');
        formData.append('csrfmiddlewaretoken', csrftoken);
        selectedStudents.forEach(id => formData.append('students', id));

        const button = $(this);
        const spinner = button.find('.spinner-border');
        button.prop('disabled', true);
        spinner.removeClass('d-none');

        $.ajax({
            url: "{% url 'semesters:manage_subject_students' semester.slug semester_subject.id %}",
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                if (response.success) {
                    showToast('success', response.message);
                    loadStudents();
                    if (response.errors) {
                        response.errors.forEach(e => showToast('error', e));
                    }
                } else {
                    showToast('error', response.error || 'Failed to add students');
                }
            },
            error: function(xhr) {
                let errorMessage = 'Error adding students';
                try {
                    const response = JSON.parse(xhr.responseText);
                    errorMessage = response.error || errorMessage;
                } catch (e) {
                    if (xhr.status === 404) errorMessage = 'Subject or semester not found';
                    else if (xhr.status === 403) errorMessage = 'Permission denied';
                    else errorMessage = xhr.statusText || errorMessage;
                }
                showToast('error', errorMessage);
            },
            complete: function() {
                button.prop('disabled', false);
                spinner.addClass('d-none');
            }
        });
    });

    // Remove students
    $('#removeStudents').on('click', function() {
        const selectedStudents = $('#enrolledStudents').val();
        if (!selectedStudents || selectedStudents.length === 0) {
            showToast('error', 'Please select at least one student to remove');
            return;
        }
        removeStudentModal.show();
    });

    $('#confirmRemoveStudent').on('click', function() {
        const selectedStudents = $('#enrolledStudents').val();
        const formData = new FormData();
        formData.append('action', 'remove');
        formData.append('csrfmiddlewaretoken', csrftoken);
        selectedStudents.forEach(id => formData.append('students', id));

        const button = $(this);
        const spinner = button.find('.spinner-border');
        button.prop('disabled', true);
        spinner.removeClass('d-none');

        $.ajax({
            url: "{% url 'semesters:manage_subject_students' semester.slug semester_subject.id %}",
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                if (response.success) {
                    showToast('success', response.message);
                    loadStudents();
                    if (response.errors) {
                        response.errors.forEach(e => showToast('error', e));
                    }
                } else {
                    showToast('error', response.error || 'Failed to remove students');
                }
                removeStudentModal.hide();
            },
            error: function(xhr) {
                let errorMessage = 'Error removing students';
                try {
                    const response = JSON.parse(xhr.responseText);
                    errorMessage = response.error || errorMessage;
                } catch (e) {
                    if (xhr.status === 404) errorMessage = 'Subject or semester not found';
                    else if (xhr.status === 403) errorMessage = 'Permission denied';
                    else errorMessage = xhr.statusText || errorMessage;
                }
                showToast('error', errorMessage);
                removeStudentModal.hide();
            },
            complete: function() {
                button.prop('disabled', false);
                spinner.addClass('d-none');
            }
        });
    });

    // Remove teacher
    $('.remove-teacher').on('click', function() {
        const teacherEmail = $(this).data('teacher-email');
        $('#confirmRemoveTeacher').data('teacher-email', teacherEmail);
        removeTeacherModal.show();
    });

    $('#confirmRemoveTeacher').on('click', function() {
        const teacherEmail = $(this).data('teacher-email');
        const button = $(this);
        const spinner = button.find('.spinner-border');
        button.prop('disabled', true);
        spinner.removeClass('d-none');

        $.ajax({
            url: "{% url 'semesters:remove_teacher_from_subject' semester.slug semester_subject.id %}",
            type: 'POST',
            headers: { 'X-CSRFToken': csrftoken },
            success: function(response) {
                if (response.success) {
                    showToast('success', response.message || 'Teacher removed successfully');
                    removeTeacherModal.hide();
                    location.reload();
                } else {
                    showToast('error', response.error || 'Failed to remove teacher');
                }
            },
            error: function(xhr) {
                let errorMessage = 'Error removing teacher';
                try {
                    const response = JSON.parse(xhr.responseText);
                    errorMessage = response.error || errorMessage;
                } catch (e) {
                    if (xhr.status === 404) errorMessage = 'Teacher or subject not found';
                    else if (xhr.status === 403) errorMessage = 'Permission denied';
                    else errorMessage = xhr.statusText || errorMessage;
                }
                showToast('error', errorMessage);
            },
            complete: function() {
                button.prop('disabled', false);
                spinner.addClass('d-none');
            }
        });
    });

    // Delete subject
    $('.delete-subject').on('click', function() {
        const subjectId = $(this).data('subject-id');
        $('#confirmDeleteSubject').data('subject-id', subjectId);
        deleteModal.show();
    });

    $('#confirmDeleteSubject').on('click', function() {
        const subjectId = $(this).data('subject-id');
        const button = $(this);
        const spinner = button.find('.spinner-border');
        button.prop('disabled', true);
        spinner.removeClass('d-none');

        $.ajax({
            url: "{% url 'semesters:delete_semester_subject' semester.slug semester_subject.id %}",
            type: 'POST',
            headers: { 'X-CSRFToken': csrftoken },
            success: function(response) {
                if (response.success) {
                    showToast('success', response.message);
                    deleteModal.hide();
                    window.location.href = "{% url 'semesters:semester_detail' semester.slug %}";
                } else {
                    showToast('error', response.error || 'Failed to delete subject');
                }
            },
            error: function(xhr) {
                let errorMessage = 'Error deleting subject';
                try {
                    const response = JSON.parse(xhr.responseText);
                    errorMessage = response.error || errorMessage;
                } catch (e) {
                    if (xhr.status === 404) errorMessage = 'Subject or semester not found';
                    else if (xhr.status === 403) errorMessage = 'Permission denied';
                    else errorMessage = xhr.statusText || errorMessage;
                }
                showToast('error', errorMessage);
            },
            complete: function() {
                button.prop('disabled', false);
                spinner.addClass('d-none');
            }
        });
    });

    // Hide teacher results when clicking outside
    $(document).on('click', function(e) {
        if (!$(e.target).closest('#teacherSearch, #teacherResults').length) {
            teacherResults.hide();
        }
    });

    // Auto-hide alerts after 5 seconds
    $('.alert').each(function() {
        const alert = $(this);
        setTimeout(function() {
            alert.fadeOut();
        }, 5000);
    });
});
</script>
{% endblock %}  